@model NSN.Models.Token
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container py-4">
    <div class="row g-4 align-items-start">
        <div class="col-md-6">
            @await Html.PartialAsync("_SaveUpdatePartial", Model)
        </div>
        <div class="col-md-6">
            @await Html.PartialAsync("_StatisticsPartial")
        </div>
    </div>

    <div class="row g-4 mt-5">
        <div class="col-md-12">
            @await Html.PartialAsync("_ViewDetailsPartial")
        </div>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script>
  let tokenChart;

  async function buildChartFromServer(){
    const res = await fetch('@Url.Action("ChartData","Dashboard")', { cache:'no-store' });
    if (!res.ok) return;
    const { labels, data } = await res.json();

    const canvas = document.getElementById('tokenPie');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    tokenChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          label: 'Total Supply',
          data,
          backgroundColor: [
              '#3B82F6', // blue
              '#EF4444', // red
              '#22C55E', // green
              '#EAB308', // yellow
              '#8B5CF6', // purple
              '#06B6D4', // cyan
              '#F97316', // orange
              '#10B981', // emerald
              '#A855F7', // violet
              '#64748B', // slate/gray
              '#F43F5E', // rose
              '#14B8A6', // teal
              '#FACC15'  // amber
          ],
          borderColor: '#fff',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 8 },
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: 'Token Statistics by Total Supply',
            font: { size: 18, weight: 'bold', family: 'Poppins, sans-serif' },
            color: '#111'
          },
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${ctx.label}: ${Number(ctx.raw ?? 0).toLocaleString()}`
            }
          },
          datalabels: {
            formatter: (value, ctx) => {
              const ds = ctx.chart.data.datasets[0].data;
              const total = ds.reduce((a,b)=>a+b,0) || 1;
                  const pct = ((value / total) * 100).toFixed(2); // two decimals
              const label = ctx.chart.data.labels[ctx.dataIndex] || '';
              return `${label}\n${pct}%`;
            },
            color: '#fff',
            font: { weight: 'bold', size: 14 },
            textAlign: 'center',
            anchor: 'center',
            align: 'center',
            clamp: true,
            clip: false
          }
        },
        animation: { duration: 500, easing: 'easeOutCubic' }
      },
      plugins: [ChartDataLabels]
    });
  }

  async function refreshChart(){
    const res = await fetch('@Url.Action("ChartData","Dashboard")', { cache:'no-store' });
    if (!res.ok || !tokenChart) return;
    const { labels, data } = await res.json();
    tokenChart.data.labels = labels;
    tokenChart.data.datasets[0].data = data;
    tokenChart.update();
  }

  async function refreshDetails(){
    const html = await (await fetch('@Url.Action("DetailsPartial","Dashboard")')).text();
    const el = document.querySelector('#details');
    if (el) el.outerHTML = html;
  }

  window.refreshChart = refreshChart;
  window.refreshDetails = refreshDetails;

  document.addEventListener('DOMContentLoaded', buildChartFromServer);
    </script>
}

<style>
    html {
        scroll-behavior: smooth;
    }

    section {
        scroll-margin-top: 90px;
    }
    /* Sticky navbar offset */
</style>